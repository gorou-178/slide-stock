# T-507 — OIDCログインエンドポイントのユニットテスト作成

## ロール
@qa

## 依存
- T-500（完了: docs/auth-spec.md）

## 概要

docs/auth-spec.md セクション 3.1（GET /api/auth/login）および セクション 3.2（GET /api/auth/callback）に基づき、TDD 前提のユニットテストを作成する。

## テスト対象

### GET /api/auth/login

1. **正常系: Google Authorization URL へのリダイレクト**
   - レスポンスが 302 であること
   - Location ヘッダーが `https://accounts.google.com/o/oauth2/v2/auth` で始まること
   - クエリパラメータに `client_id`, `redirect_uri`, `response_type=code`, `scope`, `state` が含まれること
   - `auth_state` Cookie が Set-Cookie に含まれること（HttpOnly, Max-Age=300）

### GET /api/auth/callback

2. **正常系: Authorization Code → セッション発行**
   - Google Token Endpoint への fetch を mock
   - 有効な ID Token（署名検証 mock）を返す設定
   - `state` パラメータと `auth_state` Cookie が一致する場合
   - レスポンスが 302（/ へリダイレクト）であること
   - `session` Cookie が Set-Cookie に含まれること
   - Cookie 属性: HttpOnly, Secure, SameSite=Lax, Path=/api, Max-Age=604800

3. **異常系: state 不一致**
   - `state` パラメータと `auth_state` Cookie が異なる場合
   - 403 Forbidden が返ること

4. **異常系: code パラメータ欠落**
   - `code` が無い場合
   - 400 Bad Request が返ること

5. **異常系: Token 交換失敗**
   - Google Token Endpoint が エラーを返す場合
   - 500 Internal Server Error が返ること

6. **異常系: ID Token 検証失敗**
   - ID Token の iss, aud, exp が不正な場合
   - 401 Unauthorized が返ること

7. **ユーザー upsert**
   - 新規ユーザー: INSERT が実行されること
   - 既存ユーザー: email/name が UPDATE されること

## テストファイル配置

```
worker/auth/auth-handler.test.ts
```

## 実装メモ

- Google Token Endpoint (`https://oauth2.googleapis.com/token`) は fetch mock で差し替え
- JWKS 検証は mock（署名検証の正常/異常をテスト可能に）
- D1 は miniflare の D1 binding もしくは mock で対応
- 既存の `worker/middleware/test-auth-bypass.test.ts` のテストスタイルに合わせること
