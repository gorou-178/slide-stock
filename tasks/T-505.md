# 認証フローのユニットテスト・E2Eテスト

Google OIDC 認証フローの自動テストを作成してください。

## 前提

- docs/auth-spec.md の仕様に基づいてテストを設計する
- T-502（認証ミドルウェア）と T-504（フロントエンド Sign-In）が実装済みであること
- 既存のテストインフラ: Vitest + Playwright
- テストヘルパー: test/helpers/, src/test/

## やること

1. ユニットテスト（Vitest）:
   - 認証ミドルウェアのテスト:
     - 有効なセッション Cookie → AuthContext が設定される
     - 無効なセッション Cookie → 401 が返る
     - セッション Cookie なし → 401 が返る
     - TEST_MODE=true → test-auth-bypass が使用される
   - POST /api/auth/callback のテスト:
     - 有効な ID Token → セッション Cookie が発行される
     - 無効な ID Token → エラーが返る
     - 新規ユーザー → users テーブルに INSERT される
     - 既存ユーザー → users テーブルが UPDATE される
   - POST /api/auth/logout のテスト:
     - セッション Cookie がクリアされる

2. E2E テスト（Playwright）:
   - 未認証ユーザーが /stocks にアクセス → /login にリダイレクト
   - ログイン後 → /stocks にリダイレクト
   - ログアウト → /login にリダイレクト

3. テストが正しく「失敗する」ことを確認する（実装前の場合）

4. テストコードをコミットする
