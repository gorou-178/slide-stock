# Queueコンシューマー実装

Cloudflare Queues のコンシューマーを実装し、oEmbed メタデータ取得 → D1 更新のフローを完成させてください。

## 前提

- docs/oembed-spec.md の Queue メッセージスキーマに従う
- T-521（oEmbed サービス）と T-522（Queue 設定）が実装済みであること
- worker/index.ts の ExportedHandler に queue() ハンドラを追加する

## やること

1. worker/index.ts に queue() ハンドラを追加する:
   - Queue メッセージからstock_id, original_url, provider を取得する
   - worker/lib/oembed.ts の fetchOembedMetadata() を呼ぶ
   - 成功時: D1 の stocks テーブルを更新する（title, author_name, thumbnail_url, embed_url, status='ready'）
   - 失敗時: status='failed' に更新する
   - message.ack() で処理完了を通知する

2. `npm test` で全テストがパスすることを確認する

3. 変更をコミットする
