# T-508 — 認証ミドルウェアのユニットテスト作成

## ロール
@qa

## 依存
- T-501（OIDCログインエンドポイント実装）

## 概要

docs/auth-spec.md セクション 5（セッション管理）に基づき、本番用認証ミドルウェアの TDD 前提ユニットテストを作成する。

## テスト対象

### セッション Cookie 検証

1. **正常系: 有効なセッション Cookie**
   - 正しい署名 + 有効期限内の Cookie
   - AuthContext（userId, email, name）が正しく生成されること

2. **異常系: Cookie 未送信**
   - `session` Cookie が無い場合
   - 401 Unauthorized が返ること

3. **異常系: 署名不一致（改ざん検知）**
   - payload を改ざんした Cookie
   - 401 Unauthorized が返ること

4. **異常系: 有効期限切れ**
   - `exp` が過去の Cookie
   - 401 Unauthorized が返ること

5. **異常系: 不正なフォーマット**
   - `.` 区切りでない Cookie、base64 デコード不可な Cookie
   - 401 Unauthorized が返ること

### TEST_MODE 共存

6. **TEST_MODE=true: テスト用バイパスが優先**
   - 既存の `testAuthBypass` が動作し、セッション Cookie 検証はスキップ
   - 既存テストとの互換性を維持

7. **TEST_MODE !== "true": 本番用ミドルウェアが動作**
   - セッション Cookie 検証が実行される

### Cookie 生成ヘルパー

8. **セッション Cookie 生成**
   - `createSessionCookie(userId, secret)` が正しい形式の Cookie 値を返すこと
   - ペイロードに `uid` と `exp` が含まれること
   - `exp` が現在時刻 + 7日 であること

9. **Cookie 検証の往復テスト**
   - 生成した Cookie を検証関数に通すと元の userId が取得できること

## テストファイル配置

```
worker/middleware/session-auth.test.ts
```

## 実装メモ

- HMAC-SHA256 の署名/検証は Web Crypto API を使用
- SESSION_SECRET は固定のテスト用値を使用
- 既存の `test-auth-bypass.test.ts` のテストスタイルに合わせること
- ミドルウェアのインターフェースは `testAuthBypass` と同じ `AuthContext | null` を返す形式を想定
